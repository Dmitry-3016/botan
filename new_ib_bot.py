import logging
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,
    ConversationHandler,
)

# Структура разделов и терминов
classes = {
    "Термины": {
    "CIA Triad": "(Конфиденциальность, Целостность, Доступность)\nБазовая модель информационной безопасности:\nКонфиденциальность — защита данных от несанкционированного доступа.\nЦелостность — обеспечение точности и полноты информации.\nДоступность — обеспечение возможности доступа к информации для уполномоченных пользователей.",
    "Аутентификация": "Процесс проверки подлинности пользователя или устройства (например, по паролю, токену, биометрии).",
    "Авторизация": "Определение прав и уровня доступа пользователя после аутентификации.",
    "Аудит безопасности": "Систематическая проверка систем и процессов на соответствие стандартам безопасности и выявление уязвимостей.",
    "Уязвимость (Vulnerability)": "Слабое место в системе, которое может быть использовано злоумышленником для атаки.",
    "Эксплойт (Exploit)": "Программа или скрипт, использующий уязвимость для получения несанкционированного доступа или выполнения кода.",
    "Zero-Day (0-day)": "Уязвимость, о которой ещё не известно разработчикам и для которой нет патча.",
    "Атака социальной инженерии": "Манипулирование людьми с целью получения конфиденциальной информации или доступа.",
    "Фишинг (Phishing)": "Вид социальной инженерии: обман пользователя с целью получения логинов, паролей и другой информации через поддельные сайты или письма.",
    "Брутфорс (Brute Force)": "Перебор всех возможных комбинаций паролей или ключей для взлома.",
    "Социальная инженерия": "Комплекс методов психологического воздействия для получения доступа к информации.",
    "Риск-менеджмент": "Оценка, анализ и минимизация рисков в области информационной безопасности.",
    "Управление инцидентами": "(Incident Response) - Процедуры реагирования на инциденты безопасности: обнаружение, анализ, локализация, устранение и восстановление.",
    "Threat Intelligence": "Сбор, анализ и использование информации об актуальных угрозах и атаках.",
    "Red team": "Команда, имитирующая действия злоумышленника (атакующие).",
    "Blue team": "Команда защиты (обнаружение и реагирование на атаки).",
    "Purple team": "Взаимодействие Red и Blue для повышения эффективности защиты.",
    "Sandbox": "Изолированная среда для безопасного запуска подозрительных программ без риска для основной системы.",
    "Penetration Testing (Пентест)": "Контролируемое имитирование атак на систему с целью выявления уязвимостей.",
    "Social Engineering Toolkit (SET)": "Инструментарий для проведения атак социальной инженерии.",
    "Exploit Kit": "Набор программ и скриптов для автоматизации эксплуатации уязвимостей.",
    "Firewall": "Сетевое устройство или ПО для контроля и фильтрации трафика по заданным правилам.",
    "Intrusion Detection System (IDS)": "Система обнаружения вторжений, анализирующая сетевой трафик или события для выявления атак.",
    "Intrusion Prevention System (IPS)": "Система обнаружения и предотвращения атак в режиме реального времени.",
    "Malware": "Вредоносное программное обеспечение (вирусы, трояны, шпионское ПО и др.).",
    "Rootkit": "Набор инструментов, скрывающих присутствие вредоносного ПО или злоумышленника в системе.",
    "Privilege Escalation": "Использование уязвимости для повышения прав доступа в системе.",
    "Hashing": "Процесс одностороннего преобразования данных для хранения паролей и проверки целостности.",
    "Salt": "Случайные данные, добавляемые к паролю перед хешированием для защиты от радужных таблиц.",
    "Phishing Kit": "Набор готовых инструментов и шаблонов для создания фишинговых сайтов.",
    "Command and Control (C2)": "Сервер или инфраструктура злоумышленника для управления заражёнными компьютерами.",
    "Trojan": "Вредоносная программа, замаскированная под легитимное ПО.",
    "VPN (Virtual Private Network)": "Технология создания зашифрованного канала связи поверх публичной сети.",
    "Zero Trust": "Модель безопасности, отсутствующая доверие по умолчанию; контроль всюду и всякого.",
    "Data Exfiltration": "Несанкционированный вывод данных из системы или сети злоумышленником.",
    "Log Analysis": "Анализ журналов событий для обнаружения подозрительных действий и инцидентов.",
    "Pharming": "Перенаправление пользователей с легитимного ресурса на вредоносный сайт.",
    "Session Fixation": "Атака, при которой злоумышленник устанавливает сессию для жертвы и затем её использует.",
    "Tokenization": "Замена конфиденциальных данных на уникальные идентификаторы для защиты информации.",
    "Threat Hunting": "Проактивный поиск угроз внутри сети или системы на основе анализа и гипотез.",
    "Vulnerability Assessment": "Автоматизированный или ручной анализ систем на наличие уязвимостей без попыток эксплуатации.",
    "WAF (Web Application Firewall)": "Фаервол для фильтрации и защиты веб-приложений от атак.",
    "Brute Force Protection": "Механизмы ограничения попыток ввода пароля для предотвращения перебора.",
    "Cryptojacking": "Незаконное использование ресурсов компьютера для майнинга криптовалюты.",
    "Denial of Service (DoS)": "Атака, направленная на недоступность сервисов для законных пользователей.",
    "Distributed Denial of Service (DDoS)": "DoS-атака с использованием множества распределённых источников.",
    "White Hat": "Этичный специалист по безопасности, проводящий легальные тесты на проникновение.",
    "Black Hat": "Злоумышленник, использующий свои навыки для вреда и кражи данных.",
    "Gray Hat": "Специалист, работающий на грани этических норм, например, выявляющий уязвимости без согласия.",
    "Exploit Development": "Процесс создания и тестирования эксплойтов для уязвимостей.",
    "Reverse Engineering": "Анализ исполняемых файлов или программ для понимания внутренней логики.",
    "Social Engineering": "Методы психологического воздействия для обхода технических средств безопасности.",
    "Attack Surface": "Совокупность всех точек взаимодействия системы с внешним окружением, уязвимых к атакам."
    },
    "Инструменты и технологии": {
    "Nmap": "Сканер портов и сервисов. Позволяет обнаружить открытые порты, версии сервисов, операционные системы на удалённых хостах.",
    "Metasploit Framework": "Платформа для поиска, разработки и эксплуатации уязвимостей. Содержит обширную базу эксплойтов и полезных нагрузок.",
    "Burp Suite": "Комплексный инструмент для тестирования безопасности веб-приложений: перехват, анализ и изменение HTTP-трафика, автоматизация поиска уязвимостей.",
    "Wireshark": "Анализатор сетевого трафика. Позволяет захватывать и анализировать пакеты, выявлять аномалии и атаки.",
    "John the Ripper": "Популярный инструмент для взлома паролей методом перебора и словарных атак.",
    "Hydra": "Мощный инструмент для перебора паролей по различным протоколам (SSH, FTP, HTTP и др.).",
    "Aircrack-ng": "Набор инструментов для анализа и взлома Wi-Fi сетей (WEP, WPA, WPA2).",
    "Nikto": "Сканер веб-серверов на предмет известных уязвимостей, неправильных настроек и устаревших программных компонентов.",
    "SQLmap": "Автоматизированный инструмент для поиска и эксплуатации SQL-инъекций в веб-приложениях.",
    "Gobuster / Dirbuster": "Инструменты для поиска скрытых директорий и файлов на веб-серверах методом перебора.",
    "OWASP ZAP": "Бесплатный прокси для тестирования веб-приложений, автоматизации поиска уязвимостей и анализа трафика.",
    "Hashcat": "Один из самых быстрых инструментов для взлома паролей по хешам с использованием GPU.",
    "Msfvenom": "Генерация полезных нагрузок (payloads) для эксплуатации уязвимостей и создания шеллов.",
    "Masscan": "Очень быстрый сканер портов, способен сканировать весь интернет за считанные минуты.",
    "BeEF": "Фреймворк для атак через браузер, позволяет управлять скомпрометированными браузерами и проводить XSS-атаки.",
    "Responder": "Инструмент для перехвата учётных данных через атаки на протоколы NTLM и LLMNR в локальной сети.",
    "Empire": "Платформа для постэксплуатации с возможностями PowerShell-скриптинга и управления скомпрометированными системами.",
    "Cobalt Strike": "Коммерческий инструмент для симуляции атак, проведения разведки и постэксплуатации на целевых системах.",
    "BloodHound": "Средство для анализа Active Directory, выявления уязвимых связей и путей эскалации привилегий.",
    "Nikto": "Автоматический сканер веб-серверов для выявления слабых мест и известных уязвимостей.",
    "Impacket": "Набор Python-библиотек и инструментов для работы с протоколами Windows и сетевого взаимодействия.",
    "Socat": "Инструмент для организации перенаправления портов и туннелирования трафика.",
    "Fierce": "DNS сканер для обнаружения поддоменов, зонального перебора и разведки.",
    "Netcat": "Универсальный сетевой инструмент для чтения и записи данных по сети, часто используется для создания обратных шеллов.",
    "Ettercap": "Инструмент для проведения MITM-атак и анализа сетевого трафика в локальной сети.",
    "Autopsy": "Средство для проведения цифровой криминалистики и анализа данных дисков и образов.",
    "Volatility": "Фреймворк для анализа дампов памяти и выявления вредоносного кода или инцидентов.",
    "Radare2": "Комплексный инструмент для обратного инжиниринга и анализа бинарных файлов.",
    "Ghidra": "Бесплатный фреймворк от NSA для статического анализа двоичных файлов и реверс-инжиниринга.",
    "OpenVAS": "Полноценный сканер уязвимостей с обновляемой базой данных проверок.",
    "Nessus": "Коммерческий сканер уязвимостей с мощным функционалом и широкой поддержкой.",
    "Dirsearch": "Утилита для перебора директорий и файлов на веб-серверах.",
    "Sublist3r": "Инструмент для сбора субдоменов с использованием множества публичных источников.",
    "Amass": "Мощный инструмент для разведки и сбора информации об инфраструктуре и субдоменах.",
    "Nikto": "Автоматический сканер веб-серверов на различные уязвимости и конфигурационные ошибки.",
    "SSLScan": "Проверка конфигурации и поддержки протоколов SSL/TLS на сервере.",
    "Wfuzz": "Инструмент для веб-фуззинга, поиска и эксплуатации уязвимостей через перебор параметров.",
    "Mitmproxy": "Прокси-сервер для перехвата, анализа и изменения HTTP/HTTPS-трафика в реальном времени.",
    "Docker": "Платформа для контейнеризации, помогает изолировать и быстро развертывать тестовые среды и инструменты безопасности.",
    "Terraform": "Инструмент для автоматизации развёртывания инфраструктуры, полезен в облачном пентесте и мониторинге.",
    "Snyk": "Инструмент для анализа уязвимостей в зависимости приложений и контейнеров.",
    "TruffleHog": "Утилита для поиска секретов и ключей, случайно подключённых к системам контроля версий.",
    "Snort": "Система обнаружения вторжений (IDS) на основе анализа сетевого трафика.",
    "Suricata": "Современная IDS/IPS платформа с расширенными возможностями анализа трафика.",
    },
    "Типы атак и уязвимостей": {
    "SQL Injection (SQLi)": "Внедрение вредоносных SQL-запросов через пользовательский ввод для обхода аутентификации или получения данных.",
    "Cross-Site Scripting (XSS)": "Внедрение вредоносного JavaScript-кода на веб-страницы для кражи данных, сессий и совершения атак от имени пользователя.",
    "Cross-Site Request Forgery (CSRF)": "Атака, при которой злоумышленник заставляет пользователя выполнить нежелательное действие от его имени на доверенном сайте.",
    "Remote Code Execution (RCE)": "Уязвимость, позволяющая злоумышленнику удалённо выполнять произвольный код на целевой системе.",
    "Privilege Escalation": "Получение более высоких привилегий в системе, чем было изначально разрешено.",
    "Man-in-the-Middle (MitM)": "Перехват и возможное изменение трафика между двумя сторонами без их ведома.",
    "Denial of Service (DoS/DDoS)": "Атаки, приводящие к отказу в обслуживании, перегрузке или недоступности сервиса.",
    "Buffer Overflow": "Переполнение буфера, позволяющее записывать данные за пределы выделенной памяти и выполнять вредоносный код.",
    "Directory Traversal": "Атака, позволяющая получить доступ к файлам и каталогам вне корневой директории веб-сервера.",
    "Path Traversal": "Синоним Directory Traversal — получение доступа к файловой системе вне разрешённых директорий.",
    "Command Injection": "Внедрение и выполнение команд операционной системы через уязвимые параметры ввода.",
    "Session Hijacking": "Захват и использование чужой сессии для получения несанкционированного доступа.",
    "Clickjacking": "Обман пользователя с помощью наложения невидимых элементов для выполнения нежелательных действий.",
    "LFI/RFI (Local/Remote File Inclusion)": "Включение локальных или удалённых файлов через уязвимый ввод, что может привести к выполнению кода.",
    "XML External Entity (XXE)": "Злоупотребление внешними сущностями в XML для локального раскрытия файлов или удалённого доступа.",
    "Insecure Deserialization": "Использование недостаточно проверенных сериализованных данных для выполнения произвольного кода.",
    "Zero-Day Exploit": "Использование ранее неизвестной уязвимости до появления патча.",
    "Password Spraying": "Массированная попытка входа с ограниченным набором паролей по многим аккаунтам для обхода блокировок.",
    "Phishing": "Социальная инженерия с целью украсть конфиденциальные данные через поддельные сайты или письма.",
    "Brute Force Attack": "Перебор всех вариантов паролей или ключей с целью взлома.",
    "Subdomain Takeover": "Захват неиспользуемого поддомена для размещения вредоносного контента.",
    "DNS Spoofing": "Подмена DNS-записей для перенаправления трафика на злонамеренный ресурс.",
    "Side-Channel Attack": "Анализ побочных эффектов системы для кражи криптографических ключей или данных.",
    "Race Condition": "Воспользование временными окнами между операциями для обхода безопасности.",
    "Trojan Horse": "Малоизвестный вредоносный код, замаскированный под безобидное ПО.",
    "Backdoor": "Скрытый метод обхода обычной аутентификации для удалённого доступа.",
    "Social Engineering": "Манипуляция человеком для получения доступа к системам или информации.",
    "DNS Tunneling": "Использование DNS-запросов для обхода фильтров и передачи данных скрытым каналом.",
    "ARP Spoofing": "Подмена ARP-записей для перехвата локального сетевого трафика.",
    "Credential Stuffing": "Автоматизированное использование скомпрометированных пар логинов для входа в разные сервисы.",
    "Malware": "Вредоносное программное обеспечение любого типа для компрометации систем.",
    "Exploit Kits": "Автоматизированные наборы эксплойтов для распространения вредоносного ПО.",
    "Watering Hole Attack": "Заражение популярного среди цели веб-сайта для атак на посетителей.",
    "Click Fraud": "Автоматизированное создание ложных кликов для мошенничества в рекламе.",
    "Eavesdropping": "Перехват конфиденциальных данных в сети без модификации.",
    "Keylogger": "Программа или устройство для записи нажатий клавиш с целью кражи паролей.",
    "DNS Amplification": "Вид DDoS-атаки, в которой злоумышленник использует DNS-серверы для увеличения объёма трафика.",
    "Logic Bomb": "Вредоносный код, активирующийся при наступлении определённых условий.",
    "Firmware Attack": "Атака на низкоуровневое программное обеспечение (прошивку) устройств.",
    "Click Fraud": "Автоматизированное создание ложных кликов в рекламе для финансовой выгоды.",
    "OAuth Token Theft": "Кража токенов доступа для обхода аутентификации.",
    "HTML Injection": "Внедрение вредоносного HTML в страницы для обмана и фишинга.",
    "File Upload Vulnerability": "Загрузка вредоносных файлов на сервер для дальнейшего выполнения атак.",
    "Insider Threat": "Опасность, исходящая от сотрудников или пользователей с доступом к системе.",
    "Password Cracking": "Взлом паролей с помощью различных методов, включая словарные и радужные таблицы.",
    "API Abuse": "Неправомерное использование API для обхода безопасности или получения данных.",
    "Memory Corruption": "Ошибки управления памятью, приводящие к исполнению кода или сбоям.",
    "Sandbox Escape": "Атаки, которые позволяют выйти из изолированной среды исполнения и получить доступ к системе.",
    "TLS/SSL Stripping": "Атака, снижающая защиту HTTPS-соединения до незашифрованного HTTP.",
    "Clickjacking": "Манипуляция элементами страницы для обмана пользователя и запуска нежелательных действий."
    },
    "Сетевые и крипто технологии": {
    "VPN (Virtual Private Network)": "Технология для создания защищённого канала связи поверх незащищённой сети (например, интернет).",
    "Firewall (Межсетевой экран)": "Аппаратное или программное средство для фильтрации сетевого трафика по заданным правилам.",
    "IDS/IPS": "(Intrusion Detection/Prevention System) - Системы обнаружения и предотвращения вторжений: анализируют трафик и реагируют на подозрительную активность.",
    "TLS/SSL": "Криптографические протоколы для защиты передачи данных в интернете (например, HTTPS).",
    "PKI (Public Key Infrastructure)": "Инфраструктура открытых ключей: система управления цифровыми сертификатами и ключами.",
    "Hash-функции (SHA, MD5 и др.)": "Алгоритмы для преобразования данных в фиксированный по длине хеш-отпечаток, используются для проверки целостности.",
    "Симметричное шифрование": "Использование одного ключа для шифрования и дешифрования (например, AES, DES).",
    "Асимметричное шифрование": "Использование пары ключей — открытого и закрытого (например, RSA, ECC).",
    "JWT (JSON Web Token)": "Компактный формат для безопасной передачи информации между сторонами как JSON-объект, часто применяется для авторизации.",
    "X.509 Certificate": "Стандарт цифровых сертификатов, используемых для идентификации и шифрования в сетях.",
    "Diffie-Hellman": "Протокол обмена ключами для безопасной генерации общего секрета по незащищённому каналу.",
    "Perfect Forward Secrecy (PFS)": "Свойство протоколов, при котором компрометация ключей не влияет на безопасность прошлых сессий.",
    "IPsec": "Набор протоколов для обеспечения защищённой передачи IP-пакетов (шифрование, аутентификация).",
    "OpenVPN": "Популярное программное решение для создания VPN с использованием SSL/TLS.",
    "WireGuard": "Современный, простой и быстрый VPN-протокол с акцентом на безопасность и производительность.",
    "Signal Protocol": "Криптопротокол для обеспечения сквозного шифрования в мессенджерах и коммуникациях.",
    "OAuth 2.0": "Протокол авторизации, позволяющий передавать ограниченный доступ к ресурсам без передачи паролей.",
    "S/MIME": "Стандарт для шифрования и подписи email-сообщений на основе X.509 сертификатов.",
    "PGP/GPG": "Технологии для шифрования и цифровой подписи сообщений, основанные на асимметричном шифровании.",
    "HMAC (Hash-based Message Authentication Code)": "Комбинация хеш-функции и секретного ключа для проверки целостности и подлинности сообщений.",
    "DNSSEC": "Расширение DNS для обеспечения целостности и аутентичности DNS-записей с помощью криптографии.",
    "MAC (Media Access Control) Address": "Уникальный идентификатор сетевого интерфейса для канального уровня сети.",
    "ARP (Address Resolution Protocol)": "Протокол сопоставления IP-адресов MAC-адресам в локальной сети.",
    "802.1X": "Стандарт аутентификации пользователей в сетях Ethernet и Wi-Fi (например, для сетей с WPA2-Enterprise).",
    "Certificate Authority (CA)": "Доверенный центр сертификации, выпускающий цифровые сертификаты.",
    "CRL (Certificate Revocation List)": "Список отозванных сертификатов, больше не доверяемых системой.",
    "ECDSA": "Криптографический алгоритм цифровой подписи на основе эллиптических кривых.",
    "PGP Keyserver": "Публичный сервер для обмена открытыми ключами пользователей PGP/GPG.",
    "Port Security": "Механизмы ограничивающие доступ к сетевым портам по MAC-адресам для предотвращения атак.",
    "SYN Flood": "Тип DoS-атаки, основанный на исчерпании ресурсов сервера путём отправки большого количества SYN-запросов.",
    "ARP Spoofing": "Атака подмены ARP-записей для перехвата или изменения трафика в локальной сети.",
    "SSL/TLS Stripping": "Атака по снижению защищённого HTTPS-соединения до незашифрованного HTTP.",
    "Diffie-Hellman Key Exchange": "Протокол безопасного обмена криптографическими ключами по открытому каналу.",
    "Elliptic Curve Cryptography (ECC)": "Криптография на основе эллиптических кривых для обеспечения высокой безопасности при меньших ключах.",
    "Transport Layer Security (TLS) 1.3": "Последняя версия TLS с улучшенной безопасностью и производительностью шифрования.",
    "Nonce": "Уникальное случайное число, используемое один раз для предотвращения повторных атак.",
    "Seed": "Начальное значение для генерации псевдослучайных чисел в криптографии.",
    "Diffusion and Confusion": "Основные принципы шифрования, обеспечивающие распределение и изменение входных данных.",
    "Cryptanalysis": "Анализ и поиск уязвимостей в криптографических алгоритмах.",
    "Side-Channel Attack": "Атака на криптографию через анализ физических параметров (время, электромагнитные излучения и т.п.).",
    "Elliptic Curve Diffie-Hellman (ECDH)": "Версия протокола обмена ключами Diffie-Hellman на эллиптических кривых.",
    "Secret Sharing": "Метод распределения секрета на части, которые нужно объединить для восстановления информации.",
    "Chain of Trust": "Цепочка доверия при проверке сертификатов от корневого CA до конечного пользователя.",
    "Key Exchange": "Процесс безопасной передачи ключей шифрования между сторонами.",
    "XOR": "Операция 'исключающее ИЛИ' — фундаментальная операция в криптографии.",
    "Block Cipher Modes": "Режимы работы блочных шифров (CBC, ECB, GCM и др.) для повышения безопасности.",
    "Cryptographic Salt": "Дополнительные данные, используемые при хешировании для защиты от радужных таблиц.",
    "Entropy": "Мера непредсказуемости случайных данных в криптографии.",
    "Replay Attack": "Повторная передача захваченных данных для повторного выполнения действия.",
    "Keylogger": "Программа или устройство для записи нажатий клавиш и кражи информации.",
    "Quantum Cryptography": "Раздел криптографии, использующий принципы квантовой механики для обеспечения безопасности.",
    "DNS Tunneling": "Метод обхода фильтров через инкапсуляцию данных в DNS-запросах."
    },
    "Стандарты, процессы и фреймы": {
    "OWASP Top 10": "Список из 10 самых критичных уязвимостей веб-приложений по версии OWASP, обновляется регулярно.",
    "MITRE ATT&CK": "База знаний тактик, техник и процедур злоумышленников, используется для анализа и моделирования угроз.",
    "NIST (National Institute of Standards and Technology)": "Американский институт стандартов, разрабатывающий рекомендации и стандарты по кибербезопасности (например, NIST SP 800-53).",
    "ISO/IEC 27001": "Международный стандарт по управлению информационной безопасностью (ISMS).",
    "SOC (Security Operations Center)": "Центр мониторинга и реагирования на инциденты безопасности в организации.",
    "Vulnerability Assessment": "Процесс поиска и оценки уязвимостей в системах и приложениях.",
    "Penetration Testing (Pentest)": "Эмуляция атак для поиска уязвимостей и проверки защищённости систем.",
    "Sandboxing": "Изоляция процессов или приложений для предотвращения распространения вредоносного кода.",
    "Forensic Analysis": "Комплекс методов для расследования инцидентов, сбора и анализа цифровых доказательств.",
    "CIS Controls": "Набор конкретных мер и рекомендаций по кибербезопасности, ориентированных на уменьшение риска атак.",
    "COBIT": "Фреймворк для управления и корпоративного IT, включая элементы безопасности.",
    "PCI DSS": "Стандарт безопасности данных для организаций, работающих с платёжными картами.",
    "GDPR": "Общий регламент по защите данных, регулирующий обработку персональной информации в ЕС.",
    "ISO/IEC 27701": "Расширение ISO/IEC 27001 для управления конфиденциальностью информации (PIMS).",
    "ITIL": "Набор практик управления IT-услугами, включающий аспекты безопасности.",
    "Cyber Kill Chain": "Модель этапов атаки, разработанная Lockheed Martin, для анализа и противодействия кибератакам.",
    "NIST Cybersecurity Framework (CSF)": "Рамочная модель для управления рисками кибербезопасности на основе стандартов NIST.",
    "Threat Modeling": "Процесс системного анализа потенциальных угроз и уязвимостей для снижения риска.",
    "ISO/IEC 15408 (Common Criteria)": "Международный стандарт оценки безопасности ИТ-продуктов и систем.",
    "CSA (Cloud Security Alliance)": "Фреймворк и рекомендации по безопасности облачных вычислений.",
    "Open Red Team Framework": "Набор методик и инструментов для проведения и координации красных команд (Red Team).",
    "MITRE CAPEC": "Каталог шаблонов атак (Common Attack Pattern Enumeration and Classification) для анализа угроз.",
    "SANS Top 20": "Приоритетный список мер по улучшению кибербезопасности на основе опыта SANS Institute.",
    "ISO/IEC 22301": "Стандарт по обеспечению непрерывности бизнеса и управлению инцидентами.",
    "Log Management and SIEM": "Процессы сбора, анализа и корреляции логов для обнаружения угроз и реагирования.",
    "Patch Management": "Процесс своевременного обновления программного обеспечения для устранения уязвимостей.",
    "Security Policy Development": "Разработка и внедрение политик безопасности для управления рисками и контролем доступа.",
    "Incident Response Plan": "Документированные процедуры для эффективного реагирования на инциденты безопасности.",
    "Red Teaming": "Комплексное тестирование безопасности организации с имитацией действий реальных злоумышленников.",
    "Blue Teaming": "Действия по обороне и защите систем, мониторингу и реагированию на атаки.",
    "Purple Teaming": "Совместная работа Red и Blue команд для улучшения защитных мер и обмена информацией.",
    "Bug Bounty Programs": "Механизмы поощрения внешних специалистов за обнаружение и сообщение об уязвимостях.",
    "Security Awareness Training": "Обучение сотрудников принципам кибербезопасности для снижения риска человеческих ошибок.",
    "DevSecOps": "Интеграция практик безопасности в процессы разработки и эксплуатации ПО.",
    "Continuous Monitoring": "Непрерывное наблюдение за безопасностью систем и сетей для своевременного обнаружения угроз.",
    "Risk Assessment": "Идентификация, анализ и оценка рисков, влияющих на информационную безопасность.",
    "Business Impact Analysis (BIA)": "Определение критических бизнес-активов и оценка последствий их потери."
    },
}

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)

SECTION, TERM = range(2)
TERMS_PER_PAGE = 10


async def show_sections(update: Update, context: ContextTypes.DEFAULT_TYPE):
    reply_markup = ReplyKeyboardMarkup(
        [[k] for k in classes.keys()], resize_keyboard=True
    )
    await update.message.reply_text(
        "Выберите раздел для изучения:", reply_markup=reply_markup
    )
    return SECTION


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    reply_markup = ReplyKeyboardMarkup(
        [[k] for k in classes.keys()], resize_keyboard=True
    )
    await update.message.reply_text(
        "Привет! Я бот по информационной безопасности. Выберите раздел для изучения:",
        reply_markup=reply_markup,
    )
    return SECTION


def get_terms_page(terms, page):
    start = page * TERMS_PER_PAGE
    end = start + TERMS_PER_PAGE
    return terms[start:end]


def get_total_pages(terms):
    return (len(terms) - 1) // TERMS_PER_PAGE + 1


async def section(update: Update, context: ContextTypes.DEFAULT_TYPE):
    section = update.message.text
    if section not in classes:
        await update.message.reply_text("Пожалуйста, выберите раздел с помощью кнопок.")
        return SECTION
    context.user_data["section"] = section
    context.user_data["page"] = 0
    return await show_terms(update, context)


async def show_terms(update: Update, context: ContextTypes.DEFAULT_TYPE):
    section = context.user_data["section"]
    page = context.user_data.get("page", 0)
    terms = list(classes[section].keys())
    total_pages = get_total_pages(terms)
    page = max(0, min(page, total_pages - 1))
    context.user_data["page"] = page
    terms_page = get_terms_page(terms, page)
    keyboard = [[term] for term in terms_page]
    nav_buttons = []
    if total_pages > 1:
        if page > 0:
            nav_buttons.append("⬅️ Назад")
        if page < total_pages - 1:
            nav_buttons.append("Вперёд ➡️")
    nav_buttons += ["Обратно", "Разделы"]
    keyboard.append(nav_buttons)
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text(
        f"Раздел: {section}\nВыберите термин (стр. {page+1}/{total_pages}):",
        reply_markup=reply_markup,
    )
    return TERM


async def term(update: Update, context: ContextTypes.DEFAULT_TYPE):
    section = context.user_data.get("section")
    page = context.user_data.get("page", 0)
    term = update.message.text
    terms = list(classes[section].keys())
    total_pages = get_total_pages(terms)
    if term == "Обратно":
        return await show_terms(update, context)
    if term == "Разделы":
        return await show_sections(update, context)
    if term == "⬅️ Назад":
        context.user_data["page"] = max(0, page - 1)
        return await show_terms(update, context)
    if term == "Вперёд ➡️":
        context.user_data["page"] = min(total_pages - 1, page + 1)
        return await show_terms(update, context)
    if section not in classes or term not in classes[section]:
        await update.message.reply_text("Пожалуйста, выберите термин с помощью кнопок.")
        return TERM
    text = f"<b>{term}</b>\n{classes[section][term]}"
    # Разбиваем длинный текст на части по 4096 символов
    max_len = 4096
    parts = [text[i : i + max_len] for i in range(0, len(text), max_len)]
    for part in parts:
        await update.message.reply_text(part, parse_mode="HTML")
    reply_markup = ReplyKeyboardMarkup([["Обратно", "Разделы"]], resize_keyboard=True)
    await update.message.reply_text("Выберите действие:", reply_markup=reply_markup)
    return TERM


async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("До встречи!", reply_markup=ReplyKeyboardRemove())
    return ConversationHandler.END


def main():
    import os

    TOKEN = os.getenv("TELEGRAM_TOKEN") or "8141597316:AAF1qM2GG6ku_D0pJCe5bF_nutG-LULaOiA"
    app = ApplicationBuilder().token(TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            SECTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, section)],
            TERM: [MessageHandler(filters.TEXT & ~filters.COMMAND, term)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )
    app.add_handler(conv_handler)
    print("Бот запущен. Нажмите Ctrl+C для остановки.")
    app.run_polling()


if __name__ == "__main__":
    main()
